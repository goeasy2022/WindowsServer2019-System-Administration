# 本地安全策略加固服务

# 1. 配置密码策略

域环境中, 密码的策略是在域控制器上配置, 加入到域的其他服务器和计算机无法在本地配置密码策略.

将WS2019-52恢复到加域前的快照.

密码策略是在本地安全策略中进行配置.

![image-20240427193321955](07. 本地安全策略加固服务.assets/image-20240427193321955.png)

![image-20240427193429177](07. 本地安全策略加固服务.assets/image-20240427193429177.png)

![image-20240427193446471](07. 本地安全策略加固服务.assets/image-20240427193446471.png)

## 1.1 复杂度要求

建议开启.

开启后, 密码必须至少有6个字符.

![image-20240427193728058](07. 本地安全策略加固服务.assets/image-20240427193728058.png)

案例: 密码复杂度设置.

开启:

![image-20240427195505630](07. 本地安全策略加固服务.assets/image-20240427195505630.png)

创建用户:

此时, 因为密码复杂度不符合要求, 创建用户失败.

![image-20240427195543696](07. 本地安全策略加固服务.assets/image-20240427195543696.png)

禁用密码复杂度要求:

禁用后. 即使密码为123, 也可以成功.

![image-20240427195702995](07. 本地安全策略加固服务.assets/image-20240427195702995.png)

![image-20240427195714015](07. 本地安全策略加固服务.assets/image-20240427195714015.png)

## 1.2 最短使用期限

数值为0: 修改一次密码后, 可立即再次修改.

数值为1-998: 修改一次密码后, 需要等1-998天才能再次修改密码.

密码最短使用期限必须小于密码最长使用期限, 除非将密码最长使用期间设置为0, 此时表示密码永不过期.

如果密码最长使用期限设置为0, 那么最短使用期限可以为0-998间的任何值.

![image-20240427194240460](07. 本地安全策略加固服务.assets/image-20240427194240460.png)

案例: 最短使用期限.

0天表示可以立即修改:

注销后, 登录test1用户, 测试修改.

![image-20240427200306836](07. 本地安全策略加固服务.assets/image-20240427200306836.png)

![image-20240427200315200](07. 本地安全策略加固服务.assets/image-20240427200315200.png)

修改为1后, 需要等一天才能再次修改:

![image-20240427195949367](07. 本地安全策略加固服务.assets/image-20240427195949367.png)

![image-20240427200456801](07. 本地安全策略加固服务.assets/image-20240427200456801.png)

![image-20240427200425912](07. 本地安全策略加固服务.assets/image-20240427200425912.png)

![image-20240427200742603](07. 本地安全策略加固服务.assets/image-20240427200742603.png)

## 1.3 最长使用期限

密码最多可以使用几天. 根据公司环境设置.

如果为0, 表示密码永不过期.

![image-20240427194226331](07. 本地安全策略加固服务.assets/image-20240427194226331.png)

案例: 最长使用期限为0.

![image-20240427200921369](07. 本地安全策略加固服务.assets/image-20240427200921369.png)

![image-20240427200943202](07. 本地安全策略加固服务.assets/image-20240427200943202.png)

## 1.4 密码长度最小值

密码至少需要多少个字符. 可以设为1-14之间.

设为0表示不需要密码.

![image-20240427194333076](07. 本地安全策略加固服务.assets/image-20240427194333076.png)

## 1.5 强制密码历史

在使用某个之前使用过的重复密码前, 必须先已经使用几次其他的非重复的密码.

![image-20240427194427337](07. 本地安全策略加固服务.assets/image-20240427194427337.png)

## 1.6 最小密码长度审核

用于触发当设置的密码过短时, 进行审核事件触发.

如果最小密码长度为10, 而该长度审核的值为8. 那么不会发出审核事件.

如果最小密码长度为10, 而该长度审核的值为11. 那么当新设置的密码长度小于该审核值时, 会发出审核事件.

![image-20240427194530258](07. 本地安全策略加固服务.assets/image-20240427194530258.png)

## 1.7 用可还原的加密来存储密码

![image-20240427194926137](07. 本地安全策略加固服务.assets/image-20240427194926137.png)

## 1.8 公司案例

```
开启密码复杂度要求

大写字母

小写字母

数字

特殊符号

最少10位

不能用最近的6个密码

密码3个月过期

最少使用1天
```

# 2. 账户锁定策略

![image-20240427203126085](07. 本地安全策略加固服务.assets/image-20240427203126085.png)

## 2.1 允许管理员账户锁定

内置管理员一般不配置锁定. 管理员密码要设置的长, 而且难以猜测.

![image-20240427203328314](07. 本地安全策略加固服务.assets/image-20240427203328314.png)

## 2.2 账户锁定阈值

几次错误后, 锁定账号. 0次表示账户不锁定.

![image-20240427203449721](07. 本地安全策略加固服务.assets/image-20240427203449721.png)

## 2.3 账户锁定时间

账户锁定多久后, 自动解锁.

![image-20240427203538847](07. 本地安全策略加固服务.assets/image-20240427203538847.png)

## 2.4 重置账户锁定计数器

重启账户锁定计数器的时间和账户锁定时间要一致. 防止黑客不断的利用计数器的重置来猜密码. 

账户锁定时间也不要太短. 建议锁定30分钟, 计数器重置也是30分钟. 这样即使有人恶意猜密码, 那么也要等30分钟计数器到时后, 才能再次猜密码. 否则账号就被锁了, 要等30分钟.

## 2.5 解锁本地账号

![image-20240427204430497](07. 本地安全策略加固服务.assets/image-20240427204430497.png)

# 3. 启动审核策略跟踪安全事件

## 3.1 审核事件举例

审核策略用于告诉计算机记录哪些安全事件.

![image-20240427212712949](07. 本地安全策略加固服务.assets/image-20240427212712949.png)

审核账户管理: 比如, 当有人在计算机上创建了账户时, 会进行记录.

![image-20240427212748097](07. 本地安全策略加固服务.assets/image-20240427212748097.png)

![image-20240427212836347](07. 本地安全策略加固服务.assets/image-20240427212836347.png)

审核账户登录事件: 只要用户在登录时, 找到我这台服务器进行用户名和密码认证, 那么就记录下来. 一般是域控.

![image-20240427212905914](07. 本地安全策略加固服务.assets/image-20240427212905914.png)

![image-20240427213033947](07. 本地安全策略加固服务.assets/image-20240427213033947.png)

![image-20240427212914295](07. 本地安全策略加固服务.assets/image-20240427212914295.png)

审核登录事件: 区别于审核用户登录事件, 这个审核登录事件一般审核的是登录到我这台本地计算机.

![image-20240427213255900](07. 本地安全策略加固服务.assets/image-20240427213255900.png)

![image-20240427213302591](07. 本地安全策略加固服务.assets/image-20240427213302591.png)

![image-20240427213312390](07. 本地安全策略加固服务.assets/image-20240427213312390.png)

## 3.2 事件记录位置

![image-20240427213635770](07. 本地安全策略加固服务.assets/image-20240427213635770.png)

登录失败事件:

![image-20240427213742507](07. 本地安全策略加固服务.assets/image-20240427213742507.png)

![image-20240427213757099](07. 本地安全策略加固服务.assets/image-20240427213757099.png)

记录创建用户事件:

![image-20240427213910449](07. 本地安全策略加固服务.assets/image-20240427213910449.png)

![image-20240427213951069](07. 本地安全策略加固服务.assets/image-20240427213951069.png)

![image-20240427214008118](07. 本地安全策略加固服务.assets/image-20240427214008118.png)

![image-20240427214021622](07. 本地安全策略加固服务.assets/image-20240427214021622.png)

创建一个用户会记录多个安全事件.

![image-20240427214313885](07. 本地安全策略加固服务.assets/image-20240427214313885.png)

## 3.3 审核对象访问

可以用于记录用户对文件/文件夹的操作.

审核对象访问这里是针对所有用户. 也可以对某个单独的对象进行审核设置.

![image-20240427214512761](07. 本地安全策略加固服务.assets/image-20240427214512761.png)

![image-20240427214527227](07. 本地安全策略加固服务.assets/image-20240427214527227.png)

案例: 在服务器上创建一个homework目录, 禁止test1用户删除. 切换到test1用户, 尝试删除该目录.

![image-20240427214623148](07. 本地安全策略加固服务.assets/image-20240427214623148.png)

只给test1读取权限.

![image-20240427214704579](07. 本地安全策略加固服务.assets/image-20240427214704579.png)

在文件夹目录添加审核. 审核test1用户失败的读, 写, 修改等操作. (这里是仅针对该文件夹审核某个用户)

![image-20240427215654662](07. 本地安全策略加固服务.assets/image-20240427215654662-17142190148932.png)

![image-20240427215708716](07. 本地安全策略加固服务.assets/image-20240427215708716.png)

切换到test1用户, 尝试删除.

![image-20240427214818281](07. 本地安全策略加固服务.assets/image-20240427214818281.png)

再回到管理员账号, 查看安全事件. 这里需要仔细查找安全事件记录.

![image-20240427220817924](07. 本地安全策略加固服务.assets/image-20240427220817924.png)

![image-20240427220828859](07. 本地安全策略加固服务.assets/image-20240427220828859.png)

![image-20240427220839075](07. 本地安全策略加固服务.assets/image-20240427220839075.png)

# 4. 授予用户系统权限

这个权限针对的是用户对于操作系统的权限. 比如, 能否修改操作系统时间, 能否关闭系统的.

![image-20240427221116131](07. 本地安全策略加固服务.assets/image-20240427221116131.png)

案例: 更改系统时间.

![image-20240427221151135](07. 本地安全策略加固服务.assets/image-20240427221151135.png)

![image-20240427221205638](07. 本地安全策略加固服务.assets/image-20240427221205638.png)

# 5. 配置安全选项

## 5.1 交互登录不显示上次登录用户名

启用后, 在计算机开机/注销重新登录时, 不会显示上次登录的用户名.

![image-20240428010202286](07. 本地安全策略加固服务.assets/image-20240428010202286.png)

默认是禁用的, 所以计算机开机/注销重新登录时, 会显示上次登录的用户名.

![image-20240428010548762](07. 本地安全策略加固服务.assets/image-20240428010548762.png)

开启后, 就不会显示这些用户名了.

![image-20240428010750893](07. 本地安全策略加固服务.assets/image-20240428010750893.png)

![image-20240428010946838](07. 本地安全策略加固服务.assets/image-20240428010946838.png)

## 5.2 计算机不活动限制

计算机多久没有操作后, 会锁定计算机. 需要再次输入账号密码登录.

![image-20240428140305387](07. 本地安全策略加固服务.assets/image-20240428140305387.png)

案例: 设置10秒不使用, 就锁定屏幕.

![image-20240428140331119](07. 本地安全策略加固服务.assets/image-20240428140331119.png)

## 5.3 提示用户在密码过期之间更改密码

![image-20240428140448276](07. 本地安全策略加固服务.assets/image-20240428140448276.png)

## 5.4 无须按Ctrl+Alt+Del

默认是启用的, 用户在登录计算机时, 需要按Ctrl+Alt+Del来输入账号和密码.

关闭后, 则不需要. 只需按任意键, 就可以进入输入用户名和密码的界面.

![image-20240428140612923](07. 本地安全策略加固服务.assets/image-20240428140612923.png)

## 5.5 试图登录的用户的消息文本和消息标题

在用户输入用户名和密码前, 给一个提示信息.

![image-20240428140955416](07. 本地安全策略加固服务.assets/image-20240428140955416.png)

![image-20240428141015766](07. 本地安全策略加固服务.assets/image-20240428141015766.png)

![image-20240428141033447](07. 本地安全策略加固服务.assets/image-20240428141033447.png)

![image-20240428141048329](07. 本地安全策略加固服务.assets/image-20240428141048329.png)

## 5.6 本地账户的共享和安全模型

一般针对计算机上的共享资源访问. 通常情况下, 当用户访问计算机上的共享资源时, 需要输入账号和密码. 而有时, 我们希望用户可以直接访问, 无需输入用户名和密码. 此时就可以用本地的Guest账号进行访问.

当用户访问该计算机的共享资源时, 会直接使用Guest账号进行访问. 无需输入账号密码.

![image-20240428141532543](07. 本地安全策略加固服务.assets/image-20240428141532543.png)

![image-20240428141740865](07. 本地安全策略加固服务.assets/image-20240428141740865.png)

仅来宾: 访问时使用本地的Guest账号.

Guest账号案例:

1. WS2019-52开启本地来宾访问.

![image-20240428141826541](07. 本地安全策略加固服务.assets/image-20240428141826541.png)

2. 启用本地Guest账号, 不设置密码.

![image-20240428141901451](07. 本地安全策略加固服务.assets/image-20240428141901451.png)

3. 禁用, 使用空密码的本地账号只允许进行控制台登录.

![image-20240428142043343](07. 本地安全策略加固服务.assets/image-20240428142043343.png)

![image-20240428142050448](07. 本地安全策略加固服务.assets/image-20240428142050448.png)

4. 在需要登录共享服务器的那台主机上(这里是WS2019-53), 修改本地组策略, 启用不安全的来宾登录.

![image-20240428142515632](07. 本地安全策略加固服务.assets/image-20240428142515632.png)

![image-20240428142601005](07. 本地安全策略加固服务.assets/image-20240428142601005.png)

![image-20240428142624248](07. 本地安全策略加固服务.assets/image-20240428142624248-17142783844641.png)

5. 服务器本地创建共享.

![image-20240428142806783](07. 本地安全策略加固服务.assets/image-20240428142806783.png)

6. 其他计算机进行访问测试.

此时, 在其他的计算机上就可以直接访问该服务器的共享了. 并且创建的文件的所有者属于Guest. 如果还是访问不了, 那么要关闭文件共享服务器的防火墙.

这种利用Guest的方式, 适用于客户端没有键盘鼠标去输入用户名和密码的情况.

# 6. 软件限制策略-控制服务器允许运行的软件

通过策略, 限制哪些软件可以运行在本地计算机.

默认是没有限制的, 任何软件都可以在本地运行.

![image-20240428210732013](07. 本地安全策略加固服务.assets/image-20240428210732013.png)

![image-20240428210815547](07. 本地安全策略加固服务.assets/image-20240428210815547.png)

不允许: 无论用户的访问权如何, 软件都不会运行. 即使是本地管理员也无法运行. 

如果将策略设置为默认不允许, 那么很有可能造成连管理员都无法打开本地安全策略, 任何都无法运行任何软件.

![image-20240428210828528](07. 本地安全策略加固服务.assets/image-20240428210828528.png)

基本用户: 允许程序访问一般用户可以访问的资源, 但没有管理员的访问权.

![image-20240428210931984](07. 本地安全策略加固服务.assets/image-20240428210931984.png)

不受限: 软件访问权由用户的访问权来决定.

![image-20240428210957901](07. 本地安全策略加固服务.assets/image-20240428210957901.png)

一般都设为默认不受限. 然后, 通过其他规则, 来指定不允许的软件.

![image-20240428211243418](07. 本地安全策略加固服务.assets/image-20240428211243418.png)

## 6.1 哈希规则

哈希是具有固定长度的一系列字节，用于唯一标识某个软件程序或文件。 哈希由哈希算法计算。 为软件程序创建哈希规则后，软件限制策略将计算该程序的哈希。 当用户尝试打开某个软件程序时，会将该程序的哈希与软件限制策略的现有哈希规则进行比较。 不管软件程序位于计算机上的哪个位置，该程序的哈希都始终相同。 但是，如果以任何方式对软件程序做了更改，则其哈希也会更改，不再与软件限制策略的哈希规则中的哈希匹配。

例如，可以创建一个哈希规则并将安全级别设置为“不允许”，以防止用户运行特定的文件。 可以重命名某个文件或将其移到另一个文件夹，而哈希仍保持相同。 但是，如果对该文件进行了任何更改，则也会更改它的哈希值，并允许它绕过限制。

![image-20240428211316974](07. 本地安全策略加固服务.assets/image-20240428211316974.png)

案例: 禁止所有用户使用计算器.

![image-20240428211727695](07. 本地安全策略加固服务.assets/image-20240428211727695.png)

![image-20240428211738694](07. 本地安全策略加固服务.assets/image-20240428211738694.png)

重启服务器生效.

![image-20240428211938812](07. 本地安全策略加固服务.assets/image-20240428211938812.png)

## 6.2 路径规则

禁止某个目录下的程序被运行.

把路径添加到其他规则即可. 尤其是对于一个共享文件夹, 为了避免有人把一个病毒文件放了进去, 又运行了病毒文件.

## 6.3 证书规则

软件开发完, 通过数字证书进行签名, 防止被人恶意修改再发布.

以Git安装程序为例.

![image-20240428224135810](07. 本地安全策略加固服务.assets/image-20240428224135810.png)

可以先把证书创建出来, 然后在证书规则中指定, 只有被该证书签名了的.exe程序才能运行, 或者都不能运行.

# 7. APPLocker

APPLocker可以进行更细致的控制. 允许哪些用户运行哪些软件, 不允许哪些用户运行哪些软件.

![image-20240428224516048](07. 本地安全策略加固服务.assets/image-20240428224516048.png)

案例: 拒绝test1用户, 打开notepad.exe.

1. 创建test2用户.

![image-20240428224807554](07. 本地安全策略加固服务.assets/image-20240428224807554.png)

2. 创建规则, 不允许test1打开notepad.exe.

![](07. 本地安全策略加固服务.assets/image-20240428225243165.png)

![image-20240428225304500](07. 本地安全策略加固服务.assets/image-20240428225304500.png)

![image-20240428225325680](07. 本地安全策略加固服务.assets/image-20240428225325680.png)

![image-20240428225339423](07. 本地安全策略加固服务.assets/image-20240428225339423.png)

![image-20240428225421664](07. 本地安全策略加固服务.assets/image-20240428225421664.png)

![image-20240428225506158](07. 本地安全策略加固服务.assets/image-20240428225506158.png)

![image-20240428225513681](07. 本地安全策略加固服务.assets/image-20240428225513681.png)

3. 创建了拒绝的规则后, 系统会创建默认的运行规则, 运行其他人打开该程序.

![image-20240428225540775](07. 本地安全策略加固服务.assets/image-20240428225540775.png)

4. 配置强制规则, 否则不会生效.

![image-20240428230030296](07. 本地安全策略加固服务.assets/image-20240428230030296.png)

5. 确保Application Identity服务运行.

![image-20240428230206195](07. 本地安全策略加固服务.assets/image-20240428230206195.png)

![image-20240428230402219](07. 本地安全策略加固服务.assets/image-20240428230402219.png)

![image-20240428230421255](07. 本地安全策略加固服务.assets/image-20240428230421255.png)

6. 切换到test1和test2测试.

test1

![image-20240428230525142](07. 本地安全策略加固服务.assets/image-20240428230525142.png)

test2

此时, 会发现, test2登录后, 无法点击Windows开始按钮, 也无法打开Search功能, 没反应. 这是系统bug, 我们可以在FileExplorer中找到notepad.exe尝试打开.

![image-20240428231819773](07. 本地安全策略加固服务.assets/image-20240428231819773.png)

# 8. 使用组策略控制用户和计算机的行为

![image-20240428232942659](07. 本地安全策略加固服务.assets/image-20240428232942659.png)

案例: 禁止打开cmd和注册表编辑器.

![image-20240428233011297](07. 本地安全策略加固服务.assets/image-20240428233011297.png)

![image-20240428233023903](07. 本地安全策略加固服务.assets/image-20240428233023903.png)

![image-20240428233042997](07. 本地安全策略加固服务.assets/image-20240428233042997.png)

测试.

![image-20240428233114730](07. 本地安全策略加固服务.assets/image-20240428233114730.png)

![image-20240428233125792](07. 本地安全策略加固服务.assets/image-20240428233125792.png)

即使是本地管理员账号也无法打开. 但是本地管理员可以进行权限的修改.

# 9. 使用登录脚本给手机发短信, 监控用户登录

![image-20240428234031239](07. 本地安全策略加固服务.assets/image-20240428234031239.png)

把脚本添加到开机启动登录脚本中. 一旦有人登录, 那么该脚本会自动运行. 提示有人登录.

![image-20240428234307689](07. 本地安全策略加固服务.assets/image-20240428234307689.png)



# 10. 在域中使用组策略统一配置服务器安全

新建一个服务器组织单位, 把两个服务器移动到服务器组织单位. 独立管理该组织单位.

![image-20240428235219971](07. 本地安全策略加固服务.assets/image-20240428235219971.png)

![image-20240428235237330](07. 本地安全策略加固服务.assets/image-20240428235237330.png)

![image-20240428235250809](07. 本地安全策略加固服务.assets/image-20240428235250809.png)

创建了一个组织单位, 就可以在域的组策略中, 独立进行管理.

![image-20240428235514823](07. 本地安全策略加固服务.assets/image-20240428235514823.png)

![image-20240428235526010](07. 本地安全策略加固服务.assets/image-20240428235526010-17143125261811.png)

![image-20240428235602987](07. 本地安全策略加固服务.assets/image-20240428235602987.png)

![image-20240428235623702](07. 本地安全策略加固服务.assets/image-20240428235623702.png)

启用密码复杂度要求. 

![image-20240429000152736](07. 本地安全策略加固服务.assets/image-20240429000152736.png)

![image-20240429000143263](07. 本地安全策略加固服务.assets/image-20240429000143263.png)

三次错误, 锁定账号. 

![image-20240429000213143](07. 本地安全策略加固服务.assets/image-20240429000213143.png)

给该组织单位中的服务器, 分配管理员. 让域用户成为这个组织单位内的服务器的管理员.

![image-20240429000102498](07. 本地安全策略加固服务.assets/image-20240429000102498.png)

![image-20240429000120571](07. 本地安全策略加固服务.assets/image-20240429000120571.png)

编辑了组策略后, 需要在被管理的主机进行更新. 一般一个小时后会自动刷新. 

![image-20240429000353520](07. 本地安全策略加固服务.assets/image-20240429000353520.png)

验证密码复杂度.

登录到WS2019-52. 刷新组策略前. 可以看到账户锁定阈值没变.

![image-20240429000643731](07. 本地安全策略加固服务.assets/image-20240429000643731.png)

密码长度最小值也没变.

![image-20240429000658019](07. 本地安全策略加固服务.assets/image-20240429000658019.png)

刷新组策略.

![image-20240429000719375](07. 本地安全策略加固服务.assets/image-20240429000719375.png)

再次查看.

![image-20240429000934767](07. 本地安全策略加固服务.assets/image-20240429000934767.png)

![image-20240429000944516](07. 本地安全策略加固服务.assets/image-20240429000944516.png)

local1登录时, 修改密码. 验证密码必须大于10位.

![image-20240429001040248](07. 本地安全策略加固服务.assets/image-20240429001040248.png)

验证local1可以在WS2019-52上创建新账号.

![image-20240429001231999](07. 本地安全策略加固服务.assets/image-20240429001231999.png)

并且自动把local1和local2两个用户添加到了Administrators组.

![image-20240429002349879](07. 本地安全策略加固服务.assets/image-20240429002349879.png)

而其他的域用户是没有权限在服务器本地创建账号的.

![image-20240429001819513](07. 本地安全策略加固服务.assets/image-20240429001819513.png)

**加入到域中的计算机, 无论是服务器还是客户端, 都会优先使用域的组策略. 如果设置了域的组策略, 那么是无法在本地进行修改的. 如果域中的组策略没有配置, 那么可以在本地修改.**





