# 搭建文件服务器

# 1. 介绍NTFS权限和共享权限

文件服务器硬件要求: 

- 硬盘容量大
- 转速高

本文将`Windows Server 2019-52`作为文件服务器. 该文件服务器要求加入到`daveit.com`域中.

1. 利用域管理员账号, 登录到文件服务器.

![image-20240311124551972](05. 搭建文件服务器.assets/image-20240311124551972.png)

2. 在`E`盘创建`doc`目录, 作为共享目录.

![image-20240311125803428](05. 搭建文件服务器.assets/image-20240311125803428.png)

3. 在域控上, 创建一个`Teacher`组, 并且创建两个账号(`Wang`, `Zhang`), 加入到`Teacher`组.

![image-20240311130655030](05. 搭建文件服务器.assets/image-20240311130655030.png)

4. 设置`doc`文件夹的共享权限, 赋予`Teacher`组读取和写入权限.

![image-20240311131808107](05. 搭建文件服务器.assets/image-20240311131808107.png)

![image-20240311131835097](05. 搭建文件服务器.assets/image-20240311131835097.png)

![image-20240311131845207](05. 搭建文件服务器.assets/image-20240311131845207.png)

![image-20240311131906243](05. 搭建文件服务器.assets/image-20240311131906243.png)

5. 在`W10-1`上, 登录`Wang`账号, 测试`doc`目录的读取和写入.

![image-20240311133148905](05. 搭建文件服务器.assets/image-20240311133148905.png)

6. 查看`doc`目录的NTFS权限. `Teacher`组有完全控制权限.

![image-20240311133340952](05. 搭建文件服务器.assets/image-20240311133340952.png)

7. 将`doc`赋予`Teacher`组的共享权限改为仅读取.

![image-20240311133502866](05. 搭建文件服务器.assets/image-20240311133502866.png)

8. 再次测试`Wang`账号在`doc`目录的读取和写入.

仍然可以读取.

![image-20240311133547713](05. 搭建文件服务器.assets/image-20240311133547713.png)

但是无法再次写入.

![image-20240311133607065](05. 搭建文件服务器.assets/image-20240311133607065.png)

也无法在此前`Wang`自己创建的目录中写入.

![image-20240311133634704](05. 搭建文件服务器.assets/image-20240311133634704.png)这里之所以`Wang`无法再次写入, 是因为共享权限里的写入权限被取消了, 共享权限里的写入被取消了, NTFS的写入权限也会被同时取消. 而账号如果想在共享文件夹内进行操作, 那么共享权限和NTFS权限同时需要满足.

9. 把共享权限中`Teacher`的写入权限重新添加, 测试`Wang`又可以再次在`doc`目录写入数据.

![image-20240311135420639](05. 搭建文件服务器.assets/image-20240311135420639.png)

![image-20240311135500216](05. 搭建文件服务器.assets/image-20240311135500216.png)

10. 使用共享向导: 共享向导针对某个文件夹开启后, 会把共享的权限同时应用在NTFS权限上. 如果共享权限是读取, 那么NTFS权限也会被设为读取. 如果共享权限是读取和写入, 那么NTFS权限会被设为完全控制. 

![image-20240311143636925](05. 搭建文件服务器.assets/image-20240311143636925.png)

![image-20240311143715283](05. 搭建文件服务器.assets/image-20240311143715283.png)

11. 如果想要实现更细致精确的权限控制, 那么要取消文件夹的使用共享向导功能.

新建`homework`文件夹, 取消使用共享向导功能.

![image-20240421171655884](05. 搭建文件服务器.assets/image-20240421171655884.png)

![image-20240311144918215](05. 搭建文件服务器.assets/image-20240311144918215.png)

此时, 需要先进行高级共享.

![image-20240311145057841](05. 搭建文件服务器.assets/image-20240311145057841.png)

![image-20240311145230139](05. 搭建文件服务器.assets/image-20240311145230139.png)

![image-20240311145244783](05. 搭建文件服务器.assets/image-20240311145244783.png)

设置了高级共享后, 并不会在NTFS权限中, 给予`Teacher`组相应的权限, 而是需要单独配置NTFS权限.

![image-20240311145342591](05. 搭建文件服务器.assets/image-20240311145342591.png)

总结: 

1. 只要通过`UNC`路径的访问, 就会受到共享权限和NTFS权限的控制. `UNC`就是: `\\10.0.0.52`. 无论是通过远程访问, 还是在文件服务器本地访问, 只要是通过`UNC`路径访问的都会受到共享权限和NTFS权限的控制.
2. 如果是打开的本地路径(`E:\doc`), 那么本地路径只受NTFS权限的控制.

3. 用户实际具有的权限是共享权限和NTFS权限的交集.

# 2. 多次共享和隐藏共享

## 2.1 多次共享

被共享的文件夹, 在文件服务器本地的名, 可以和被共享出去的名称不同. 比如, 在文件服务器本地, 文件夹的名称是`PPT`, 而发布到网络上的名称可以是`Files`或者是其他的名字. 并且, 一个文件服务器本地的共享目录, 可以对应多个网络上不同名字的共享目录.

1. 在文件服务器创建`PPT`共享文件夹.

![image-20240311155640299](05. 搭建文件服务器.assets/image-20240311155640299.png)

2. 在`DC`创建`Stu`组, 创建用户`Li`, `Meng`, 然后加入到`Stu`组.

![image-20240311160101576](05. 搭建文件服务器.assets/image-20240311160101576.png)

3. 先把`PPT`目录共享给`Stu`组, 只允许学生查看.

`\\10.0.0.52\Stu-Files`

![image-20240311160348949](05. 搭建文件服务器.assets/image-20240311160348949.png)

![image-20240311160411841](05. 搭建文件服务器.assets/image-20240311160411841.png)

![image-20240311160421639](05. 搭建文件服务器.assets/image-20240311160421639.png)

4. 再共享为`Teacher-Files`, 允许老师读写.

![image-20240311160658650](05. 搭建文件服务器.assets/image-20240311160658650.png)

![image-20240311161004476](05. 搭建文件服务器.assets/image-20240311161004476.png)

5. 给`PPT`目录添加NTFS权限.

`Stu`组只能读.

![image-20240311162120446](05. 搭建文件服务器.assets/image-20240311162120446.png)

`Teacher`组可以读写.

![image-20240311162202591](05. 搭建文件服务器.assets/image-20240311162202591.png)

6. 测试学生组和老师组的访问.

Li属于学生组.

![image-20240311161148089](05. 搭建文件服务器.assets/image-20240311161148089-17101339084101.png)

![image-20240311161227713](05. 搭建文件服务器.assets/image-20240311161227713.png)

![image-20240311161855869](05. 搭建文件服务器.assets/image-20240311161855869.png)

`Stu`组只能在`Stu-Files`中查看.

![image-20240311162302077](05. 搭建文件服务器.assets/image-20240311162302077.png)

![image-20240311162253704](05. 搭建文件服务器.assets/image-20240311162253704.png)

`Teacher`组可以在`Teacher-Files`中查看和写入.

![image-20240311162359889](05. 搭建文件服务器.assets/image-20240311162359889.png)

![image-20240311162413795](05. 搭建文件服务器.assets/image-20240311162413795.png)

切换到`Stu`账号, 发现学生也能写入. 这是因为, 共享路径有`Everyone`的权限. 需要把`Everyone`的权限删除.

![image-20240311162747838](05. 搭建文件服务器.assets/image-20240311162747838.png)

![image-20240311162800391](05. 搭建文件服务器.assets/image-20240311162800391.png)

![image-20240311162816368](05. 搭建文件服务器.assets/image-20240311162816368.png)

![image-20240311162831998](05. 搭建文件服务器.assets/image-20240311162831998.png)

再次测试学生组和老师组的权限.

学生可以查看`Stu-Files`, 但是不能写入.

![image-20240311163006987](05. 搭建文件服务器.assets/image-20240311163006987.png)

![image-20240311162957123](05. 搭建文件服务器.assets/image-20240311162957123.png)

学生不可以查看`Teacher-Files`目录, 因为在`Teacher-Files`的共享权限设置了只有`Teacher`组有权限读写.

![image-20240311163116733](05. 搭建文件服务器.assets/image-20240311163116733.png)

切换到老师账号.

老师也无法访问学生的目录.

![image-20240311163204876](05. 搭建文件服务器.assets/image-20240311163204876.png)

老师可以在自己的目录读写.

![image-20240311163243704](05. 搭建文件服务器.assets/image-20240311163243704-17101351640852.png)

但是不可以删除别人的文件. 虽然在共享中添加了更改权限, 但是因为没有NTFS更改权限, 所以老师还是不能修改其他人的目录.

![image-20240311163331234](05. 搭建文件服务器.assets/image-20240311163331234.png)

![image-20240311163336046](05. 搭建文件服务器.assets/image-20240311163336046.png)

注意: 只有域管理员能管理文件服务器的共享,  普通用户没有权限. 而且, 共享只是针对目录, 文件是没办法共享的.

在文件服务器的计算机管理中, 可以查看到当前服务器共享出去的目录都有哪些, 以及其他具体信息.

![image-20240311163708629](05. 搭建文件服务器.assets/image-20240311163708629.png)

![image-20240311164117408](05. 搭建文件服务器.assets/image-20240311164117408.png)

## 2.2 默认共享

![image-20240311164227974](05. 搭建文件服务器.assets/image-20240311164227974.png)

这些默认共享都是为了域管理员准备的, 只有域管理员账号能访问这些共享.

每个硬盘分区都有一个默认共享.

通过域管理员访问`c$`.

![image-20240311164622030](05. 搭建文件服务器.assets/image-20240311164622030.png)

`E$`.

![image-20240311164653491](05. 搭建文件服务器.assets/image-20240311164653491.png)

`ADMIN$`.

![image-20240311164712482](05. 搭建文件服务器.assets/image-20240311164712482.png)

## 2.3 隐藏共享

共享目录后带有`$`后缀的文件夹就是隐藏共享. 此时, 必须知道目录名才能被访问.

1. 在服务器创建`pic$`目录, 设为隐藏共享, 仅给管理员完全控制权限.

![image-20240311165737325](05. 搭建文件服务器.assets/image-20240311165737325.png)

![image-20240311165757207](05. 搭建文件服务器.assets/image-20240311165757207.png)

2. 修改NTFS权限.

![image-20240311170211581](05. 搭建文件服务器.assets/image-20240311170211581.png)

![image-20240421174139781](05. 搭建文件服务器.assets/image-20240421174139781.png)

3. 在`Windows Server 2019-52`上, 通过域管理员账号访问, 看不到`pic`目录, 因为已经被隐藏了.

![image-20240311170329341](05. 搭建文件服务器.assets/image-20240311170329341-17101370098143.png)

4. 需要添加`pic$`, 才能访问.

![image-20240311170953536](05. 搭建文件服务器.assets/image-20240311170953536.png)

5. 而其他用户访问到`10.0.0.52`是看不到`pic`目录的, 也无法访问`pic$`.

![image-20240311171042202](05. 搭建文件服务器.assets/image-20240311171042202.png)

![image-20240311171051842](05. 搭建文件服务器.assets/image-20240311171051842.png)

# 3. 管理默认共享

默认共享存在安全隐患, 一旦管理员的密码泄露, 那么就可以远程连接到的服务器的系统目录把文件拷贝走.

所以, 可以把默认共享给删了.

```cmd
C:\Users\Administrator.DAVEIT>net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             默认共享
IPC$                                         远程 IPC
E$           E:\                             默认共享
pic$         E:\pic
ADMIN$       C:\Windows                      远程管理
doc          E:\doc
homework     E:\homework
The command completed successfully.
```

```cmd
C:\Users\Administrator.DAVEIT>net share /?
The syntax of this command is:

NET SHARE
sharename
          sharename=drive:path [/GRANT:user,[READ | CHANGE | FULL]]
                               [/USERS:number | /UNLIMITED]
                               [/REMARK:"text"]
                               [/CACHE:Manual | Documents| Programs | BranchCache | None]
          sharename [/USERS:number | /UNLIMITED]
                    [/REMARK:"text"]
                    [/CACHE:Manual | Documents | Programs | BranchCache | None]
          {sharename | devicename | drive:path} /DELETE
          sharename \\computername /DELETE
```

```cmd
# 删除c$, ADMIN$, E$

C:\Users\Administrator.DAVEIT>net share c$ /delete
c$ was deleted successfully.


C:\Users\Administrator.DAVEIT>net share E$ /delete
E$ was deleted successfully.


C:\Users\Administrator.DAVEIT>net share ADMIN$ /delete
ADMIN$ was deleted successfully.


C:\Users\Administrator.DAVEIT>net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
pic$         E:\pic
IPC$                                         远程 IPC
doc          E:\doc
homework     E:\homework
The command completed successfully.
```

并且, 可以让服务器每次开机, 都执行默认共享目录的删除操作.

1. 把删除的命令写入到`.bat`脚本中.

![image-20240311192706355](05. 搭建文件服务器.assets/image-20240311192706355.png)

2. 添加到开机自动运行脚本.

![image-20240311192908683](05. 搭建文件服务器.assets/image-20240311192908683.png)

![image-20240311192931026](05. 搭建文件服务器.assets/image-20240311192931026.png)

![image-20240311192947874](05. 搭建文件服务器.assets/image-20240311192947874.png)

![image-20240311193004947](05. 搭建文件服务器.assets/image-20240311193004947.png)

开机脚本存放路径: `C:\Windows\System32\GroupPolicy\Machine\Scripts\Startup`

![image-20240311193257959](05. 搭建文件服务器.assets/image-20240311193257959.png)

![image-20240311193313466](05. 搭建文件服务器.assets/image-20240311193313466.png)

3. 之后, 服务器每次开机, 这些默认共享目录就会被删除.

这里恢复`Windows Server 2019-52`到加域快照, 测试脚本.

```cmd
# 添加脚本前有如下默认共享.

C:\Users\Administrator.DAVEIT>net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             默认共享
IPC$                                         远程 IPC
ADMIN$       C:\Windows                      远程管理
The command completed successfully.
```

添加脚本.

![image-20240311193742126](05. 搭建文件服务器.assets/image-20240311193742126.png)

重启服务器验证.

```cmd
C:\Users\Administrator.DAVEIT>net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
IPC$                                         远程 IPC
The command completed successfully.
```

也可以通过注册表去管理默认共享.

1. 将服务器恢复到加域快照.

```cmd
C:\Users\Administrator.DAVEIT>net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             默认共享
IPC$                                         远程 IPC
ADMIN$       C:\Windows                      远程管理
The command completed successfully.
```

2. 修改注册表.

路径: `计算机\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters`  

```cmd
创建AutoShareWks, Dword值为:00000000
创建AutoShareServer, Dword值为:00000000
```

![image-20240311205437440](05. 搭建文件服务器.assets/image-20240311205437440-17101508779514.png)

![image-20240311210216759](05. 搭建文件服务器.assets/image-20240311210216759.png)

3. 重启服务器.

![image-20240311210153688](05. 搭建文件服务器.assets/image-20240311210153688.png)

# 4. 使用net share命令管理共享

- 查看共享 `net share`

- 创建共享 `net share sharedata=e:\data`

注意: 一个文件服务器上, 不能有重复的共享名.

![image-20240311211658129](05. 搭建文件服务器.assets/image-20240311211658129.png)

```cmd
# 在服务器创建一个目录, 名为doc, 共享名为docfile

C:\Users\Administrator.DAVEIT>net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             默认共享
IPC$                                         远程 IPC
E$           E:\                             默认共享
ADMIN$       C:\Windows                      远程管理
docfile      e:\doc
The command completed successfully.
```

![image-20240311211740109](05. 搭建文件服务器.assets/image-20240311211740109.png)

- 删除共享 `net share sharedata /delete`

```cmd
C:\Users\Administrator.DAVEIT>net share docfile /delete
docfile was deleted successfully.


C:\Users\Administrator.DAVEIT>net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             默认共享
E$           E:\                             默认共享
IPC$                                         远程 IPC
ADMIN$       C:\Windows                      远程管理
The command completed successfully.
```

- `run - gpedit.msc` 打开组策略编辑器

# 5. 脱机使用文件

脱机使用文件: 计算机在离线的清空下, 如何访问和修改文件服务器上的共享文件.

1. 将`doc`目录共享给`Everyone`, 并且具有读写权限.

![image-20240311212203405](05. 搭建文件服务器.assets/image-20240311212203405.png)

2. 开启共享缓存.

![image-20240311212328568](05. 搭建文件服务器.assets/image-20240311212328568.png)

![image-20240311212522654](05. 搭建文件服务器.assets/image-20240311212522654.png)

![image-20240311212820718](05. 搭建文件服务器.assets/image-20240311212820718.png)

3. 在`doc`目录中, 创建两个文件.

![image-20240311212927162](05. 搭建文件服务器.assets/image-20240311212927162.png)

4. 在`W10-1`上访问共享, 选择**始终脱机可用**.

![image-20240311213257251](05. 搭建文件服务器.assets/image-20240311213257251.png)

![image-20240311213345817](05. 搭建文件服务器.assets/image-20240311213345817.png)

![image-20240311213408651](05. 搭建文件服务器.assets/image-20240311213408651.png)

5. 断开`W10-1`的网络, 再次测试访问`file1`.

![image-20240311213434915](05. 搭建文件服务器.assets/image-20240311213434915.png)

![image-20240311213452616](05. 搭建文件服务器.assets/image-20240311213452616.png)

![image-20240311213517555](05. 搭建文件服务器.assets/image-20240311213517555-17101533177875.png)

![image-20240311213617754](05. 搭建文件服务器.assets/image-20240311213617754.png)

![image-20240311213630781](05. 搭建文件服务器.assets/image-20240311213630781.png)



6. 同步更新.

此时, 服务器上的文件是旧版的.

![image-20240311213741656](05. 搭建文件服务器.assets/image-20240311213741656.png)

7. 在客户端连网后, 选择同步.

![image-20240311213834221](05. 搭建文件服务器.assets/image-20240311213834221.png)

![image-20240311213844803](05. 搭建文件服务器.assets/image-20240311213844803.png)

8. 回到服务器查看.

![image-20240311213918053](05. 搭建文件服务器.assets/image-20240311213918053.png)

9. 假如, 脱机时, 服务器上也有人修改了文章, 那么再次连网同步时, 会出现冲突.

断开计算机网络.

![image-20240311214420059](05. 搭建文件服务器.assets/image-20240311214420059.png)

计算机上编辑`file1`.

![image-20240311214526938](05. 搭建文件服务器.assets/image-20240311214526938.png)

服务器上编辑`file1`.

![image-20240311214905739](05. 搭建文件服务器.assets/image-20240311214905739.png)

10. 计算机上连网, 同步`file1`.

![image-20240311214959804](05. 搭建文件服务器.assets/image-20240311214959804.png)

![image-20240311215010934](05. 搭建文件服务器.assets/image-20240311215010934.png)

![image-20240311215142029](05. 搭建文件服务器.assets/image-20240311215142029-17101543022326.png)

![image-20240311215202732](05. 搭建文件服务器.assets/image-20240311215202732.png)

![image-20240311215206364](05. 搭建文件服务器.assets/image-20240311215206364.png)

![image-20240311215217864](05. 搭建文件服务器.assets/image-20240311215217864.png)

![image-20240311215235066](05. 搭建文件服务器.assets/image-20240311215235066.png)

![image-20240311215251911](05. 搭建文件服务器.assets/image-20240311215251911.png)

![image-20240311215305237](05. 搭建文件服务器.assets/image-20240311215305237.png)

![image-20240311215320086](05. 搭建文件服务器.assets/image-20240311215320086.png)

# 6. 访问共享文件夹排错

1. 查看访问共享文件夹使用的端口.

`netstat -n`

无论使用`ip`地址访问, 还是计算机名称访问, 访问的都是文件服务器的`TCP 445`端口.

![image-20240311220330882](05. 搭建文件服务器.assets/image-20240311220330882.png)

2. 服务器防火墙配置.

`wf.msc`

![image-20240311221645957](05. 搭建文件服务器.assets/image-20240311221645957-17101558061287.png)

如果把`445`端口禁用, 那么就从外部访问文件服务器了.

3. 服务器网卡选项: **Microsoft 网络的文件和打印机共享**.

这个功能关闭了就相当于把服务器上的`445`端口关闭了.

![image-20240311221935577](05. 搭建文件服务器.assets/image-20240311221935577.png)

4. 客户端上网卡选项: **Microsoft 网络客户端**.

这个功能关闭了, 那么客户端就无法访问外部的共享了.

![image-20240311222534306](05. 搭建文件服务器.assets/image-20240311222534306.png)

5. 如果文件服务器有两个网卡, 一个连接外网, 一个连接内网. 那么要把连接外网的网卡的 **Microsoft 网络的文件和打印机共享**选项给取消, 这样就可以禁止外部的人访问文件服务器.

6. 服务器上的`WorkStation`服务, 一旦停止, 那么别人就无法访问服务器上的共享服务.

![image-20240311223244013](05. 搭建文件服务器.assets/image-20240311223244013.png)

7. 服务器上`Server`的服务是否启动.

![image-20240311223501283](05. 搭建文件服务器.assets/image-20240311223501283.png)

# 7. 将共享文件夹发布到活动目录

案例: 将文件服务器上的`doc`目录, 发布到`AD`中. 方便其他人在活动目录中查找企业只共享的资源.

1. 设置共享权限和NTFS权限.

![image-20240311231152392](05. 搭建文件服务器.assets/image-20240311231152392.png)

![image-20240311231214657](05. 搭建文件服务器.assets/image-20240311231214657.png)

2. 在`AD`中创建共享目录.

![image-20240311231249227](05. 搭建文件服务器.assets/image-20240311231249227.png)

![image-20240311231306853](05. 搭建文件服务器.assets/image-20240311231306853.png)

![image-20240311231330873](05. 搭建文件服务器.assets/image-20240311231330873.png)

3. 之后可以在`AD`中, 直接搜索该共享目录, 并且直接浏览.

![image-20240311231423811](05. 搭建文件服务器.assets/image-20240311231423811.png)

![image-20240311231435205](05. 搭建文件服务器.assets/image-20240311231435205.png)

![image-20240311231500843](05. 搭建文件服务器.assets/image-20240311231500843.png)

![image-20240311231509638](05. 搭建文件服务器.assets/image-20240311231509638.png)

4. 其余域内用户, 如果在本地安装了`AD`, 也可以这样搜索, 然后把该共享目录, 映射到网络共享.

# 8. 安装文件服务器限制文件夹大小和存放文件的类型

案例: 限制文件夹大小.

1. 安装**文件服务器资源管理器**和**重复数据删除功能**.

![image-20240311232533261](05. 搭建文件服务器.assets/image-20240311232533261.png)

![image-20240311232544716](05. 搭建文件服务器.assets/image-20240311232544716.png)

![image-20240311232553348](05. 搭建文件服务器.assets/image-20240311232553348.png)

![image-20240311232605398](05. 搭建文件服务器.assets/image-20240311232605398.png)

![image-20240311232635619](05. 搭建文件服务器.assets/image-20240311232635619.png)

![image-20240311232650841](05. 搭建文件服务器.assets/image-20240311232650841.png)

![image-20240311232703524](05. 搭建文件服务器.assets/image-20240311232703524.png)

![image-20240311232719782](05. 搭建文件服务器.assets/image-20240311232719782.png)

![image-20240311232729576](05. 搭建文件服务器.assets/image-20240311232729576-17101600498988.png)

![image-20240311233210733](05. 搭建文件服务器.assets/image-20240311233210733.png)

![image-20240311233427703](05. 搭建文件服务器.assets/image-20240311233427703.png)

2. 通过配额, 控制文件夹的大小. 这个配额是基于文件的. 而此前第四章的磁盘限额是基于用户的.

当磁盘的大小固定时, 通过配额来限制不同目录能存放的数据的大小.

![image-20240311233547102](05. 搭建文件服务器.assets/image-20240311233547102.png)

硬配额: 不允许超过最大值.

软配额: 可以超过最大值, 但是会发出警告.

![image-20240311233841413](05. 搭建文件服务器.assets/image-20240311233841413.png)

3. 测速`Sales`目录不能超过`100M`.

复制一个镜像到`Sales`目录.

![image-20240311234020766](05. 搭建文件服务器.assets/image-20240311234020766-17101608209469.png)

![image-20240311234047757](05. 搭建文件服务器.assets/image-20240311234047757.png)

案例: 限制存放的文件类型.

1. 创建文件屏蔽.

![image-20240311234418092](05. 搭建文件服务器.assets/image-20240311234418092.png)

2. 不让存放音频和视频文件.

![image-20240311234455703](05. 搭建文件服务器.assets/image-20240311234455703.png)

![image-20240311234606624](05. 搭建文件服务器.assets/image-20240311234606624.png)

3. 允许在`Sales`的子目录中放音频和视频文件.

![image-20240311234751830](05. 搭建文件服务器.assets/image-20240311234751830.png)

![image-20240311234807227](05. 搭建文件服务器.assets/image-20240311234807227.png)

![image-20240311234826499](05. 搭建文件服务器.assets/image-20240311234826499.png)

![image-20240311234830433](05. 搭建文件服务器.assets/image-20240311234830433.png)

4. 测试在`audio`中存放音频文件.

![image-20240311234903414](05. 搭建文件服务器.assets/image-20240311234903414.png)

# 9. 为域用户设置主目录

为用户设置自己的家目录.

1. 选中`Wang`, 右键属性.

![image-20240312001206160](05. 搭建文件服务器.assets/image-20240312001206160.png)

2. 在主文件夹中, 连接到远程的文件服务器.

![image-20240421181742041](05. 搭建文件服务器.assets/image-20240421181742041.png)

3. `W10-1`上`Wang`用户注销后重新登录.

![image-20240421181802961](05. 搭建文件服务器.assets/image-20240421181802961.png)

![image-20240312001547179](05. 搭建文件服务器.assets/image-20240312001547179.png)

4. 给`Li`用户也添加主目录.

![image-20240421181944291](05. 搭建文件服务器.assets/image-20240421181944291.png)

5. `W10-1`上登录`Li`账户.

![image-20240421182032090](05. 搭建文件服务器.assets/image-20240421182032090.png)

# 10. 文件服务器统计重复的文件

1. 在`E`盘中的不同位置存放`1.txt`文件.

2. 存储报告管理.

![image-20240312002245517](05. 搭建文件服务器.assets/image-20240312002245517.png)

![image-20240312002326577](05. 搭建文件服务器.assets/image-20240312002326577.png)

![image-20240312002356957](05. 搭建文件服务器.assets/image-20240312002356957.png)

![image-20240312002406369](05. 搭建文件服务器.assets/image-20240312002406369.png)

![image-20240312002418291](05. 搭建文件服务器.assets/image-20240312002418291.png)

![image-20240312002453645](05. 搭建文件服务器.assets/image-20240312002453645.png)

# 11. 在域环境中配置分布式文件系统DFS

DFS: 利用一个中间转接站, 把请求转发给后端的真实服务器. 转接站只配置一些链接, 指向文件真实存在的地方.

1. 在DC上安装分布式文件系统, DFS命名空间.

![image-20240421183816523](05. 搭建文件服务器.assets/image-20240421183816523.png)

![image-20240421183828780](05. 搭建文件服务器.assets/image-20240421183828780.png)

2. 在WS2019-52和WS2019-53上安装DFS复制.

![image-20240421184224558](05. 搭建文件服务器.assets/image-20240421184224558.png)

![image-20240421184154314](05. 搭建文件服务器.assets/image-20240421184154314.png)

3. 两个文件服务器上, 创建共享目录. 共享给Everyone读写.

![image-20240421185140834](05. 搭建文件服务器.assets/image-20240421185140834.png)

![image-20240421185152296](05. 搭建文件服务器.assets/image-20240421185152296.png)

4. DC上配置DFS Manager.

![image-20240421185253616](05. 搭建文件服务器.assets/image-20240421185253616.png)

这里的服务器就是DFS的根服务器, 也就是本台DC.

![image-20240421185359143](05. 搭建文件服务器.assets/image-20240421185359143.png)

![image-20240421185422355](05. 搭建文件服务器.assets/image-20240421185422355-17136896628211.png)

![image-20240421185505739](05. 搭建文件服务器.assets/image-20240421185505739.png)

用户访问Doc这个共享目录, 实际访问的是两个文件服务器上的目录. 所以权限是受到两个文件服务器上的目录的权限控制的. 和这里的共享文件夹权限无关.

![image-20240421185627285](05. 搭建文件服务器.assets/image-20240421185627285-17136897878752.png)

![image-20240421185707755](05. 搭建文件服务器.assets/image-20240421185707755.png)

![image-20240421185715555](05. 搭建文件服务器.assets/image-20240421185715555.png)

![image-20240421185729026](05. 搭建文件服务器.assets/image-20240421185729026.png)

5. 创建目标目录映射.

![image-20240421190202775](05. 搭建文件服务器.assets/image-20240421190202775.png)

![image-20240421190236220](05. 搭建文件服务器.assets/image-20240421190236220.png)

![image-20240421190323472](05. 搭建文件服务器.assets/image-20240421190323472.png)

6. 在W10-1上访问测试.

直接通过域名访问DC服务器即可.

![image-20240421190622897](05. 搭建文件服务器.assets/image-20240421190622897.png)



![image-20240421190630967](05. 搭建文件服务器.assets/image-20240421190630967.png)

注意: 不一定在DC上进行DFS创建和管理, 再任意服务器都行, 只要有管理员权限即可.

# 12. 利用DFS实现容错和负载均衡

利用DFS实现文件访问的负载均衡. 通过在名称空间中指定用户访问规则, 实现用户访问调度.

1. 给WS52再添加一个目标文件夹. 这个目标文件夹, 要指向WS2019-53.

![image-20240421192226483](05. 搭建文件服务器.assets/image-20240421192226483.png)



![image-20240421192307307](05. 搭建文件服务器.assets/image-20240421192307307.png)

![image-20240421192406329](05. 搭建文件服务器.assets/image-20240421192406329.png)

![image-20240421192414446](05. 搭建文件服务器.assets/image-20240421192414446.png)

![image-20240421192427326](05. 搭建文件服务器.assets/image-20240421192427326-17136914679883.png)

![image-20240421192600127](05. 搭建文件服务器.assets/image-20240421192600127.png)

![image-20240421192609326](05. 搭建文件服务器.assets/image-20240421192609326.png)

复制时, 要以已经有内容的服务器目录为主, 否则原有内容首次复制后会被清空.

![image-20240421192635678](05. 搭建文件服务器.assets/image-20240421192635678.png)

![image-20240421192731443](05. 搭建文件服务器.assets/image-20240421192731443.png)

集散型要求至少有三个成员, 会降低带宽使用. 而交错型会多额外消耗带宽, 因为每两个节点之间都要互相同步.

![image-20240421192842413](05. 搭建文件服务器.assets/image-20240421192842413.png)

![image-20240421192852716](05. 搭建文件服务器.assets/image-20240421192852716.png)

![image-20240421192903823](05. 搭建文件服务器.assets/image-20240421192903823.png)

![image-20240421192926166](05. 搭建文件服务器.assets/image-20240421192926166.png)

![image-20240421192938522](05. 搭建文件服务器.assets/image-20240421192938522.png)

![image-20240421192955166](05. 搭建文件服务器.assets/image-20240421192955166.png)

![image-20240421192958746](05. 搭建文件服务器.assets/image-20240421192958746.png)

2. 验证复制成功. 先在WS52中创建一个文件.

![image-20240421193220748](05. 搭建文件服务器.assets/image-20240421193220748.png)

3. WS2019-53上就会同步. 有可能略有延迟.

![image-20240421193403588](05. 搭建文件服务器.assets/image-20240421193403588.png)



而在WS2019-53上创建文件, 也会同步到WS2019-52上.

![image-20240421193451176](05. 搭建文件服务器.assets/image-20240421193451176.png)

![image-20240421193456767](05. 搭建文件服务器.assets/image-20240421193456767.png)

所以, 只有首次同步时, 需要指定主和从. 之后是双向同步.

4. 查看DFS保存的冲突文件, 被删除的文件, 以及其他文件.

先关闭隐藏受保护的操作系统文件.



![image-20240421193846124](05. 搭建文件服务器.assets/image-20240421193846124.png)

DfsPrivate保存的就是冲突的, 被删除的文件等.

![image-20240421193930012](05. 搭建文件服务器.assets/image-20240421193930012.png)

![image-20240421193937159](05. 搭建文件服务器.assets/image-20240421193937159.png)

当多个用户同时修改同一个文件, 就会在复制时出现冲突, 那么DFS会按照保存时间, 保存最后一个被修改的文件. 其他的文件会被放到ConflictAndDeleted目录.

# 13. 利用DFS分发和收集文件

## 13.1 实现单项复制

从WS2019-52向WS2019-53复制.

1. 进行DC的DFS复制管理.

![image-20240421194407549](05. 搭建文件服务器.assets/image-20240421194407549.png)

2. 禁用WS2019-53的发送成员身份. 这样就只有WS2019-52作为发送成员了.

![image-20240421194547800](05. 搭建文件服务器.assets/image-20240421194547800.png)



3. 测试在WS2019-52上创建文件, 可以复制到WS2019-53.

![image-20240421194656086](05. 搭建文件服务器.assets/image-20240421194656086.png)

![image-20240421194712745](05. 搭建文件服务器.assets/image-20240421194712745.png)

4. 测试在WS2019-53上创建的文件, 不会复制到WS2019-52.

![image-20240421194801146](05. 搭建文件服务器.assets/image-20240421194801146.png)

此时, 发现WS2019-52上, 还是会收到WS2019-53上复制来的文件.

![image-20240421194830809](05. 搭建文件服务器.assets/image-20240421194830809.png)

重启两台服务器. 刷新配置.

再次在WS2019-53上创建文件, 验证不会同步到WS2019-52.

![image-20240421195056762](05. 搭建文件服务器.assets/image-20240421195056762.png)

![image-20240421195106911](05. 搭建文件服务器.assets/image-20240421195106911.png)

企业案例: 总部向分公司分发信息.

1. 将总部的文件, 复制分发到分公司. 让总公司的服务器作为主, 把分公司的复制禁用.
2. 而分公司的文件, 不需要复制到总公司.

企业案例: 分公司向总部提交信息. 让所有的子公司的服务器作为主, 把总公司的复制禁用.

1. 将分公司的信息同步到总公司.
2. 总公司的信息, 不需要复制到分公司.

注意: 一旦配置了主从模式的复制, 那么客户端访问时, 访问的就是主服务器了. 当主服务器宕机, 过了缓存时间后, 才会访问从服务器.

